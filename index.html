<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hanoi Coffee Finder – Animated Markers (Free)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  /* Layout */
  html, body { height:100%; margin:0; }
  #map { height:100%; }

  /* ------- Coffee machine animation (namespaced) ------- */
  .coffee-mini {
    position: relative;
    width: 60px; height: 50px;
    transform: scale(.30);
    transform-origin: bottom center;
    pointer-events: none;
  }
  .coffee-mini .container {
    width: 300px; height: 280px;
    position: relative; top: 0; left: 0;
  }
  .coffee-mini .coffee-header {
    width: 100%; height: 80px; position: absolute; top:0; left:0;
    background-color:#ddcfcc; border-radius:10px;
  }
  .coffee-mini .coffee-header__buttons {
    width:25px; height:25px; position:absolute; top:25px;
    background:#282323; border-radius:50%;
  }
  .coffee-mini .coffee-header__buttons::after {
    content:""; width:8px; height:8px; position:absolute; bottom:-8px; left:calc(50% - 4px);
    background:#615e5e;
  }
  .coffee-mini .coffee-header__button-one { left:15px; }
  .coffee-mini .coffee-header__button-two { left:50px; }
  .coffee-mini .coffee-header__display {
    width:50px; height:50px; position:absolute; top:calc(50% - 25px); left:calc(50% - 25px);
    border-radius:50%; background:#9acfc5; border:5px solid #43beae; box-sizing:border-box;
  }
  .coffee-mini .coffee-header__details {
    width:8px; height:20px; position:absolute; top:10px; right:10px;
    background:#9b9091; box-shadow:-12px 0 0 #9b9091, -24px 0 0 #9b9091;
  }
  .coffee-mini .coffee-medium {
    width:90%; height:160px; position:absolute; top:80px; left:calc(50% - 45%);
    background:#bcb0af;
  }
  .coffee-mini .coffee-medium:before {
    content:""; width:90%; height:100px; background:#776f6e;
    position:absolute; bottom:0; left:calc(50% - 45%); border-radius:20px 20px 0 0;
  }
  .coffee-mini .coffee-medium__exit {
    width:60px; height:20px; position:absolute; top:0; left:calc(50% - 30px); background:#231f20;
  }
  .coffee-mini .coffee-medium__exit::before {
    content:""; width:50px; height:20px; border-radius:0 0 50% 50%;
    position:absolute; bottom:-20px; left:calc(50% - 25px); background:#231f20;
  }
  .coffee-mini .coffee-medium__exit::after {
    content:""; width:10px; height:10px; position:absolute; bottom:-30px; left:calc(50% - 5px); background:#231f20;
  }
  .coffee-mini .coffee-medium__arm {
    width:70px; height:20px; position:absolute; top:15px; right:25px; background:#231f20;
  }
  .coffee-mini .coffee-medium__arm::before {
    content:""; width:15px; height:5px; position:absolute; top:7px; left:-15px; background:#9e9495;
  }
  .coffee-mini .coffee-medium__cup {
    width:80px; height:47px; position:absolute; bottom:0; left:calc(50% - 40px);
    background:#fff; border-radius:0 0 70px 70px / 0 0 110px 110px;
  }
  .coffee-mini .coffee-medium__cup::after {
    content:""; width:20px; height:20px; position:absolute; top:6px; right:-13px;
    border:5px solid #fff; border-radius:50%;
  }
  @keyframes liquid {
    0%,5% { height:0; opacity:1; }
    20%,95% { height:62px; opacity:1; }
    100% { height:62px; opacity:0; }
  }
  .coffee-mini .coffee-medium__liquid {
    width:6px; height:63px; opacity:0; position:absolute; top:50px; left:calc(50% - 3px);
    background:#74372b; animation:liquid 4s 4s linear infinite;
  }
  .coffee-mini .coffee-medium__smoke {
    width:8px; height:20px; position:absolute; border-radius:5px; background:#b3aeae;
  }
  @keyframes smokeOne {
    0% { bottom:20px; opacity:0; }
    40% { bottom:50px; opacity:.5; }
    80% { bottom:80px; opacity:.3; }
    100% { bottom:80px; opacity:0; }
  }
  @keyframes smokeTwo {
    0% { bottom:40px; opacity:0; }
    40% { bottom:70px; opacity:.5; }
    80% { bottom:80px; opacity:.3; }
    100% { bottom:80px; opacity:0; }
  }
  .coffee-mini .coffee-medium__smoke-one  { opacity:0; bottom:50px; left:102px;  animation:smokeOne 3s 4s linear infinite; }
  .coffee-mini .coffee-medium__smoke-two  { opacity:0; bottom:70px; left:118px;  animation:smokeTwo 3s 5s linear infinite; }
  .coffee-mini .coffee-medium__smoke-three{ opacity:0; bottom:65px; right:118px; animation:smokeTwo 3s 6s linear infinite; }
  .coffee-mini .coffee-medium__smoke-four { opacity:0; bottom:50px; right:102px; animation:smokeOne 3s 5s linear infinite; }

  .coffee-mini .coffee-footer {
    width:95%; height:15px; position:absolute; bottom:25px; left:calc(50% - 47.5%);
    background:#41bdad; border-radius:10px;
  }
  .coffee-mini .coffee-footer::after {
    content:""; width:106%; height:26px; position:absolute; bottom:-25px; left:-8px; background:#000;
  }

  /* Small dot for overflow results (perf) */
  .cafe-dot {
    background:#8b5cf6; width:10px; height:10px; border-radius:50%;
    border:2px solid #fff; box-shadow:0 0 0 1px #8b5cf6;
  }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // === Setup map centered in Hà Nội ===
  const hanoi = [21.0278, 105.8342];
  const map = L.map('map').setView(hanoi, 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // === Coffee animation HTML (inline) ===
  const coffeeHTML = `
  <div class="coffee-mini">
    <div class="container">
      <div class="coffee-header">
        <div class="coffee-header__buttons coffee-header__button-one"></div>
        <div class="coffee-header__buttons coffee-header__button-two"></div>
        <div class="coffee-header__display"></div>
        <div class="coffee-header__details"></div>
      </div>
      <div class="coffee-medium">
        <div class="coffee-medium__exit"></div>
        <div class="coffee-medium__arm"></div>
        <div class="coffee-medium__liquid"></div>
        <div class="coffee-medium__smoke coffee-medium__smoke-one"></div>
        <div class="coffee-medium__smoke coffee-medium__smoke-two"></div>
        <div class="coffee-medium__smoke coffee-medium__smoke-three"></div>
        <div class="coffee-medium__smoke coffee-medium__smoke-four"></div>
        <div class="coffee-medium__cup"></div>
      </div>
      <div class="coffee-footer"></div>
    </div>
  </div>`;

  // Animated marker (divIcon)
  const coffeeIcon = L.divIcon({
    className: 'coffee-marker',
    html: coffeeHTML,
    iconSize: [150,130],
    iconAnchor: [75,120],
    popupAnchor: [0,-120]
  });

  // Small dot icon (for performance after first N)
  const dotIcon = L.divIcon({
    className: '',
    html: '<div class="cafe-dot"></div>',
    iconSize: [14,14],
    iconAnchor: [7,7]
  });

  // === Overpass query ===
  const radius = 1200; // meters
  const query = `
    [out:json][timeout:25];
    (
      node["amenity"="cafe"](around:${radius},${hanoi[0]},${hanoi[1]});
      way ["amenity"="cafe"](around:${radius},${hanoi[0]},${hanoi[1]});
      node["shop"="coffee"](around:${radius},${hanoi[0]},${hanoi[1]});
      way ["shop"="coffee"](around:${radius},${hanoi[0]},${hanoi[1]});
    );
    out center tags;
    
  `;

  const endpoints = [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter'
  ];

  fetchOverpass(endpoints, query)
    .then(data => renderCafes(data))
    .catch(err => {
      console.error('Overpass error:', err);
      alert('Overpass API đang bận. Thử lại sau.');
    });

  function fetchOverpass(eps, q) {
    const urlFor = ep => ep + '?data=' + encodeURIComponent(q);
    let i = 0;
    return new Promise((resolve, reject) => {
      function tryNext() {
        fetch(urlFor(eps[i]))
          .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
          .then(resolve)
          .catch(e => { i++; (i < eps.length) ? tryNext() : reject(e); });
      }
      tryNext();
    });
  }

  function renderCafes(data) {
    const els = (data && data.elements) || [];
    if (!els.length) { alert('Không thấy quán cà phê nào trong bán kính này.'); return; }

    els.forEach((e, idx) => {
      const lat = e.lat || (e.center && e.center.lat);
      const lon = e.lon || (e.center && e.center.lon);
      if (lat == null || lon == null) return;

      const tags = e.tags || {};
      const name = tags['name:vi'] || tags.name || tags['name:en'] || 'Quán cà phê';
      const addr = [tags['addr:housenumber'], tags['addr:street'], tags['addr:district'], tags['addr:city']]
        .filter(Boolean).join(', ');

      const icon = idx < 20 ? coffeeIcon : dotIcon; // animated first 20
      L.marker([lat, lon], { icon: coffeeIcon })
        .addTo(map)
        .bindPopup(`<b>${name}</b><br>${addr || ''}<br>
          <a target="_blank" href="https://www.openstreetmap.org/directions?to=${lat}%2C${lon}">Directions ↗</a>`);
    });
  }
</script>
</body>
</html>
